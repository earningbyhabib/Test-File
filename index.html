<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ফেসবুক ভেরিফিকেশন মেইল</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    #email {
      font-weight: bold;
      word-break: break-all;
      margin: 10px 0;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 5px;
    }
    button {
      padding: 8px 15px;
      margin: 5px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .message {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .fb-code {
      color: green;
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 5px;
    }
    #status {
      margin: 10px 0;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h2>ফেসবুক ভেরিফিকেশন মেইল</h2>
  <div id="status">সিস্টেম প্রস্তুত হচ্ছে...</div>
  <div id="email">ইমেইল তৈরি করা হচ্ছে...</div>
  <button onclick="copyEmail()">ইমেইল কপি করুন</button>
  <button onclick="generateNewEmail()">নতুন ইমেইল তৈরি করুন</button>
  
  <h3>ইনবক্স</h3>
  <div id="inbox">মেইল চেক করা হচ্ছে...</div>

  <script>
    let currentEmail = '';
    let mailCheckInterval;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // বিকল্প API এন্ডপয়েন্ট
    const API_ENDPOINTS = [
      'https://api.temp-mail.org/v1',
      'https://api.internal.temp-mail.io/api/v3',
      'https://api.mail.tm'
    ];

    async function generateNewEmail() {
      try {
        updateStatus('নতুন ইমেইল তৈরি করা হচ্ছে...');
        document.getElementById('inbox').innerHTML = 'লোড হচ্ছে...';
        
        // পূর্বের ইন্টারভাল ক্লিয়ার
        if(mailCheckInterval) clearInterval(mailCheckInterval);
        retryCount = 0;

        // API রোটেশন
        const apiBase = API_ENDPOINTS[retryCount % API_ENDPOINTS.length];
        
        // নতুন ইমেইল রিকোয়েস্ট
        const response = await fetch(`${apiBase}/email/new`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            min_name_length: 10,
            max_name_length: 10
          })
        });

        if (!response.ok) throw new Error('API রেসপন্স ব্যর্থ');

        const data = await response.json();
        currentEmail = data.email;
        document.getElementById('email').textContent = currentEmail;
        updateStatus('ইমেইল তৈরি সম্পন্ন!');

        // ইনবক্স চেক শুরু
        checkMail();
        mailCheckInterval = setInterval(checkMail, 5000);

      } catch(error) {
        retryCount++;
        if(retryCount < MAX_RETRIES) {
          updateStatus(`পুনরায় চেষ্টা করা হচ্ছে (${retryCount}/${MAX_RETRIES})...`);
          setTimeout(generateNewEmail, 2000);
        } else {
          updateStatus('ত্রুটি: ইমেইল তৈরি করতে ব্যর্থ। পরে আবার চেষ্টা করুন', 'error');
          document.getElementById('email').textContent = 'ত্রুটি: সার্ভার সমস্যা';
        }
      }
    }

    async function checkMail() {
      if (!currentEmail) return;
      
      try {
        updateStatus('ইনবক্স চেক করা হচ্ছে...');
        
        // API রোটেশন
        const apiBase = API_ENDPOINTS[retryCount % API_ENDPOINTS.length];
        const response = await fetch(`${apiBase}/email/${currentEmail}/messages`);
        
        if (!response.ok) throw new Error('ইনবক্স লোড করতে ব্যর্থ');
        
        const messages = await response.json();
        let inboxHTML = '';
        
        if(messages.length > 0) {
          messages.forEach(msg => {
            let messageContent = msg.body_text || msg.subject || 'কোনো টেক্সট নেই';
            
            inboxHTML += `
              <div class="message">
                <strong>থেকে:</strong> ${msg.from}<br>
                <strong>বিষয়:</strong> ${msg.subject}<br>
                <div>${messageContent}</div>
            `;
            
            // ফেসবুক কোড চেক
            if(msg.from.includes('facebook') || msg.subject.includes('Facebook')) {
              const code = extractFacebookCode(messageContent);
              if(code) {
                inboxHTML += `<div class="fb-code">ফেসবুক ভেরিফিকেশন কোড: ${code}</div>`;
                updateStatus('ফেসবুক কোড পাওয়া গেছে!', 'success');
              }
            }
            
            inboxHTML += `</div>`;
          });
        } else {
          inboxHTML = 'কোনো মেইল পাওয়া যায়নি';
        }
        
        document.getElementById('inbox').innerHTML = inboxHTML;
      } catch(error) {
        console.error('মেইল চেক করতে ব্যর্থ:', error);
      }
    }

    function updateStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? 'red' : 
                            type === 'success' ? 'green' : '#666';
    }

    function extractFacebookCode(text) {
      const codeMatch = text.match(/\b\d{5,8}\b/);
      return codeMatch ? codeMatch[0] : null;
    }

    function copyEmail() {
      if (!currentEmail) return;
      navigator.clipboard.writeText(currentEmail);
      updateStatus('ইমেইল কপি করা হয়েছে!', 'success');
    }

    // পেজ লোড হওয়ার সাথে সাথে ইমেইল তৈরি
    window.onload = generateNewEmail;
  </script>
</body>
</html>
